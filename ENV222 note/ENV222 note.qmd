---
title: "**ENV222 NOTE**"
subtitle: "*R in statistics (Advanced)*"
author:
  - "TC-tea"
date: "`r Sys.Date()`"
date-format: "YYYY.MM.DD"
format: html
toc: true
toc-location: left
fontsize: 12pt
fontfamily: Tahoma
theme: ""
---

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background-color: white;
      color: black;
    }
    .dark-mode {
      background-color: black;
      color: white;
    }
    /* Add this CSS */
    #myBtn {
      position: fixed;
      top: 20px;
      right: 20px;
      border: none;
      border-radius: 10px;
      padding: 10px;
      background-color: lightgray;
    }
    /* Add this CSS */
    #myBtn:before {
      content:"‚òÄ";
    }
    /* Add this CSS */
    .dark-mode #myBtn:before {
      content:"üåô";
    }
  </style>
</head>

<body>
  <button id="myBtn" onclick="myFunction()"></button>
  <script>
    function myFunction() {
       var element = document.body;
       element.classList.toggle("dark-mode");
       if (element.classList.contains("dark-mode")) {
         document.querySelector('meta[name="theme-color"]').setAttribute("content", "#1c1c1c");
         document.querySelector('meta[name="theme"]').setAttribute("content", "cyborg");
       } else {
         document.querySelector('meta[name="theme-color"]').setAttribute("content", "");
         document.querySelector('meta[name="theme"]').setAttribute("content", "spacelab");
       }
    }
  </script>
</body>

<a href="#" id="back-to-top" title="Back to top">^</a>
<style>
    #back-to-top {
        position: fixed;
        bottom: 20px;
        right: 20px;
        font-size: 24px;
        color: #fff;
        background-color: #000;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        text-align: center;
        line-height: 40px;
    }
</style>

üëâüèª[Click to enter the ENV222 exercise section](../ENV222 exercise/ENV222 exercise.html)<br>
üëâüèª[Click to enter the ENV221 note section](../ENV221 note/ENV221 note.html)

# <span style="color:gray; font-family:Microsoft JhengHei;">**1**</span> R-markdown syntax

## <span style="color:gray; font-family:Microsoft JhengHei;">**1.1**</span> Fundamental

-   Subscript by Rmarkdown: Use `PM~2.5~` to form PM~2.5~. <br>Subscript by html: `log<sub>2</sub>` will be displayed as log<sub>2</sub>.<br>

-   Superscript by Rmarkdown: Use `R^2^` to form R^2^. <br>Superscript by html: `2<sup>n</sup>` will be displayed as 2<sup>n</sup>.<br>

-   Use `$E = mc^2$` to form $E = mc^2$<br>

-   Use `[Link of XJTLU](http://xjtlu.edu.cn)` to form [Link of XJTLU](https://www.xjtlu.edu.cn/en/)<br>

-   Use `<center><img src="images/rstudio-qmd-how-it-works.png" width="1400" height="257"/>` or `<center> ![rstudio qmd how it works](images/rstudio-qmd-how-it-works.png){width=100%}` to form<br>

    <center>

    ![rstudio qmd how it works](images/rstudio-qmd-how-it-works.png){width="100%"}<br>

-   Use something like `{r, fig.width = 6, fig.height = 4, fig.align='center'}` in front of the code chunk to change the output graphics

-   Also, use`{r, XXX-Plot, fig.cap="XXX-Plot"}` in the front of code chunk to add a caption of this figure

-   Use something like`<span style="color:red; font-weight:bold; font-size:16px; font-family:Tahoma;">sentence</span>` to change the properties of text

-   Use<br> `| Name | Math | English |`<br> `|:----:|:-----|--------:|`<br> `| Tom  | 93   |     100 |`<br> `| Mary | 60   |      90 |`<br> to form<br>

| Name | Math | English |
|:----:|:-----|--------:|
| Tom  | 93   |     100 |
| Mary | 60   |      90 |

-   Or use

```{r echo=TRUE}
library(knitr)
df <- data.frame(
  Math = c(80, 90),
  English = c(85, 95),
  row.names = c("Tom", "Mary")
)
kable(df, format = "markdown")
```

-   Use

```         
- 1. 
- 2. 
    - 1.
    - 2.
- 3.
```

to form sub-rank like this below:<br>

-   

    1.  

-   

    2.  

    -   

        1.  

    -   

        2.  

-   

    3.  

## <span style="color:gray; font-family:Microsoft JhengHei;">**1.2**</span> Advanced

-   Numbering, caption, and cross-reference of R-plots in academic paper [Click to see the detail in ENV222 Week5-5.2](https://pzhao.org/openr/R-graphs-advanced.html)

# <span style="color:gray; font-family:Microsoft JhengHei;">**2**</span> Basic R charaters

## <span style="color:gray; font-family:Microsoft JhengHei;">**2.1**</span> Check the data type

```{r echo=TRUE}
# import dataset
x <- 'The world is on the verge of being flipped topsy-turvy.'
dtf <- read.csv('data/student_names.csv')
head(dtf)
# data type
class(x)
# length of the dataset
length(x)
# length of the sub dataset
nchar(x)
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**2.2**</span> Index to maximum and minimum values

-   Find the longest name in [*student_names.csv*]{style="color:green"}, `which.max` or `which.min` is used to find the index of the (first) minimum or maximum of a numeric (or logical) vector

```{r echo=TRUE}
name_n <- nchar(dtf$Name)
name_nmax <- which.max(name_n)
dtf$Name[name_nmax]
# or
dtf$Name[which.max(nchar((dtf$Name)))]
# or
library(magrittr)
dtf$Name %>% nchar() %>% which.max() %>% dtf$Name[.]
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**2.3**</span> Capital and small letter

```{r echo=TRUE}
# tolower() toupper()
(xupper <- toupper(x))
(dtf$pro <- tolower(dtf$Prgrm))
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**2.4**</span> Split string

```{r echo=TRUE}
# strsplit()
x_word <- strsplit(xupper, ' ')
class(x_word)
# If you want to extract the first element in the list, you need to use double brackets [[]], and if you want to extract the first sublist in the list, use single brackets []
x_word1 <- x_word[[1]]
class(x_word1)
table(x_word1)  # Form a table which involved the frequency of each char acter
x_word1[!duplicated(x_word1)]  # Find the distinct characters in the list by use duplicated() function
unique(x_word1)  # Other way yo detect the distinct characters
lapply(x_word, length)  # The output of the lapply() function is a list
sapply(x_word, length)  # The output of the sapply() function is a vector or a matrix
sapply(x_word, nchar)
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**2.5**</span> Separate column

```{r echo=TRUE}
# separate() is a function in the tidyr package that can be used to split a column in a data box into multiple columns
library(tidyr)
dtf2 <- separate(dtf, Name, c("GivenName", "LastName"), sep = ' ')  # separate(data, col, into, sep)
dtf$FamilyName <- dtf2$LastName
head(dtf)
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**2.6**</span> Extract

The world is [on]{style="color:red"} the verge of being flipped topsy-turvy.

```{r echo=TRUE}
# substr() is a built-in function in R that can be used to extract or replace substrings from a character vector
substr(x, 13, 15)  # substr(x, start, stop)
dtf$NameAbb <- substr(dtf$Name, 1, 1)
head(dtf, 3)
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**2.7**</span> Connect

```{r echo=TRUE}
# paste() function can convert multiple objects into character vectors and concatenate them
paste(x, '<end>', sep = ' ')  # paste(x1, x2,... sep, collapse)
paste(dtf$NameAbb, '.', sep = '')
paste(dtf$NameAbb, collapse = ' ')  # collapse = ' ' put all of the characters into a character
paste(dtf$NameAbb, dtf$FamilyName, sep = '. ')[7]  # This is my name for academic essay cite
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**2.8**</span> Find

```{r echo=TRUE}
# grep() function in R is a built-in function that searches for a pattern match in each element of character 
y <- c("R", "Python", "Java")
grep("Java", y)
for(i in 1:length(y)) {
  print(grep(as.character(y[i]), y))
}
sapply(y, function(x) grep(x, y))

head(table(dtf2$GivenName), 12)
grep('Jiayi', dtf$Name, value = TRUE)
grep('Jiayi|Guo', dtf$Name, value = TRUE)

# regexpr() function is used to identify the position of the pattern in the character vector, where each element is searched separately.
z <- c("R is fun", "R is cool", "R is awesome")
regexpr("is", z)  # Returns include starting position, duration length, data type ...
gregexpr("is", z)  # The gregexpr() function returns all matching positions and lengths, as a list
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**2.9**</span> Replace

```{r echo=TRUE}
# gsub()
gsub(' ', '-', x)
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**2.10**</span> [Regular expression]{style="color:orange"}

```{r echo=TRUE}
# help(regex)
# Find the one who has a given name with 4 letters and a family name with 4 letters
grep('^[[:alpha:]]{4} [[:alpha:]]{4}$', dtf$Name, value = TRUE)

# Here, parentheses are used to create a capturing group. A capturing group is a subexpression of a regular expression that can capture and store the matched text during matching. 
# In this example, the capturing group is used to extract the first word from the string. Without a capturing group, the entire matched string would be replaced with \\1 instead of just the first word.
dtf$FirstName <- gsub('^([^ ]+).+[^ ]+$', '\\1', dtf$Name)
head(dtf)
```

```{r eval=FALSE}
Rmarkdown ‰∏≠Ê≠£ÂàôË°®ËææÂºèÁöÑÂü∫Êú¨ËØ≠Ê≥ïÂ¶Ç‰∏ãÔºö
  . ÂåπÈÖç‰ªªÊÑèÂçï‰∏™Â≠óÁ¨¶ÔºåÈô§‰∫ÜÊç¢Ë°åÁ¨¶„ÄÇ
  [ ] ÂåπÈÖçÊñπÊã¨Âè∑ÂÜÖÁöÑ‰ªªÊÑè‰∏Ä‰∏™Â≠óÁ¨¶Ôºå‰æãÂ¶Ç [abc] ÂåπÈÖç a Êàñ b Êàñ c„ÄÇ
  [^ ] ÂåπÈÖçÊñπÊã¨Âè∑Â§ñÁöÑ‰ªªÊÑè‰∏Ä‰∏™Â≠óÁ¨¶Ôºå‰æãÂ¶Ç [^abc] ÂåπÈÖçÈô§‰∫Ü a Âíå b Âíå c ‰πãÂ§ñÁöÑ‰ªªÊÑèÂ≠óÁ¨¶„ÄÇ
  - Âú®ÊñπÊã¨Âè∑ÂÜÖË°®Á§∫ËåÉÂõ¥Ôºå‰æãÂ¶Ç [a-z] ÂåπÈÖçÂ∞èÂÜôÂ≠óÊØçÔºå [0-9] ÂåπÈÖçÊï∞Â≠ó„ÄÇ
  \d \D \w \W \s \S ÂàÜÂà´ÂåπÈÖçÊï∞Â≠ó„ÄÅÈùûÊï∞Â≠ó„ÄÅÂçïËØçÂ≠óÁ¨¶ÔºàÂ≠óÊØç„ÄÅÊï∞Â≠óÂíå‰∏ãÂàíÁ∫øÔºâ„ÄÅÈùûÂçïËØçÂ≠óÁ¨¶„ÄÅÁ©∫ÁôΩÁ¨¶ÔºàÁ©∫Ê†º„ÄÅÂà∂Ë°®Á¨¶ÂíåÊç¢Ë°åÁ¨¶Ôºâ„ÄÅÈùûÁ©∫ÁôΩÁ¨¶„ÄÇ
  \b \B ^ $ \ ÂàÜÂà´ÂåπÈÖçÂçïËØçËæπÁïåÔºàÂçïËØçÂíåÈùûÂçïËØç‰πãÈó¥Ôºâ„ÄÅÈùûÂçïËØçËæπÁïåÔºà‰∏§‰∏™ÂçïËØçÊàñ‰∏§‰∏™ÈùûÂçïËØç‰πãÈó¥Ôºâ„ÄÅÂ≠óÁ¨¶‰∏≤ÂºÄÂ§¥„ÄÅÂ≠óÁ¨¶‰∏≤ÁªìÂ∞æ„ÄÅËΩ¨‰πâÁ¨¶ÔºàÁî®‰∫éÂåπÈÖçÂÖÉÂ≠óÁ¨¶Êú¨Ë∫´Ôºâ„ÄÇ
  ( ) | ? + * { } \ ÂàÜÂà´ÂåπÈÖçÂàÜÁªÑÊàñÊçïËé∑Â≠êË°®ËææÂºèÔºàÂèØ‰ª•Áî®ÂèçÊñúÊù†Âä†Êï∞Â≠óÂºïÁî®ÔºâÔºåÈÄâÊã©ÔºàÂåπÈÖçÂ∑¶ËæπÊàñÂè≥ËæπÔºâÔºåÈõ∂Ê¨°Êàñ‰∏ÄÊ¨°ÈáçÂ§çÔºå‰∏ÄÊ¨°ÊàñÂ§öÊ¨°ÈáçÂ§çÔºåÈõ∂Ê¨°ÊàñÂ§öÊ¨°ÈáçÂ§çÔºåÊåáÂÆöÈáçÂ§çÊ¨°Êï∞ÔºåÈõ∂ÂÆΩÊñ≠Ë®ÄÔºàÂåπÈÖç‰ΩçÁΩÆËÄå‰∏çÊòØÂ≠óÁ¨¶Ôºâ„ÄÇ
ÁÆÄÂçïÁöÑ‰æãÂ≠êÔºåÊü•Êâæ Markdown ÈìæÊé•Ôºà[This is a link](https://www.example.com)ÔºâÔºö
\[([^\]]+)\]\(([^)]+)\)
Ëøô‰∏™Ê≠£ÂàôË°®ËææÂºèÂèØ‰ª•ÂàÜËß£‰∏∫‰ª•‰∏ãÈÉ®ÂàÜÔºö
  \[ ÂåπÈÖçÂ∑¶ÊñπÊã¨Âè∑
  ([^\]]+) ÂåπÈÖçÂπ∂ÊçïËé∑‰∏Ä‰∏™ÊàñÂ§ö‰∏™‰∏çÊòØÂè≥ÊñπÊã¨Âè∑ÁöÑÂ≠óÁ¨¶
  \] ÂåπÈÖçÂè≥ÊñπÊã¨Âè∑
  \( ÂåπÈÖçÂ∑¶ÂúÜÊã¨Âè∑
  ([^)]+) ÂåπÈÖçÂπ∂ÊçïËé∑‰∏Ä‰∏™ÊàñÂ§ö‰∏™‰∏çÊòØÂè≥ÂúÜÊã¨Âè∑ÁöÑÂ≠óÁ¨¶
  \) ÂåπÈÖçÂè≥ÂúÜÊã¨Âè∑
```

# <span style="color:gray; font-family:Microsoft JhengHei;">**3**</span> Time data in R

## <span style="color:gray; font-family:Microsoft JhengHei;">**3.1**</span> Format of time

```{r echo=TRUE}
# Check the current date
date()
# character
d1 <- "2/11/1962"
# Date/Time format, we can just directly use like "d2 + 1" to add 1 day to d2
d2 <- Sys.Date()
t2 <- Sys.time()
# Check their type
t(list(class(d1), class(d2), class(t2)))
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**3.2**</span> Numeric of date

```{r echo=TRUE}
# Use format="" to identify the character to date
d3 <- as.Date("2/11/1962", format="%d/%m/%Y" )
as.numeric(d3)
d3 + 2617
format(d3, '%Y %m %d')
format(d3, "%Y %B %d %A")
# Different format will have different meaning
d4 <- as.Date( "2/11/1962", format="%m/%d/%Y" )
d3 == d4
```

### <span style="color:gray; font-family:Microsoft JhengHei;">**3.2.1**</span> Time format codes

`%Y`: Four-digit year<br> `%y`: Two-digit year<br> `%m`: Two-digit month (01\~12)<br> `%d`: Two-digit day of the month (01\~31)<br> `%H`: Hour in 24-hour format (00\~23)<br> `%M`: Two-digit minute (00\~59)<br> `%S`: Two-digit second (00\~59)<br> `%z`: Time zone offset, for example +0800<br> `%Z`: Time zone name, for example CST

## <span style="color:gray; font-family:Microsoft JhengHei;">**3.3**</span> Calculating date

```{r echo=TRUE}
# import built-in data diet (The data concern a subsample of subjects drawn from larger cohort studies of the incidence of coronary heart disease (CHD))
library('Epi')
data("diet")
str(diet)
# Prepare data which we will deal with
bdat <- diet$dox[1]
bdat
# Some basic calculation between dates
bdat + 1

diet$dox2 <- format(diet$dox, format="%A %d %B %Y")
head(diet$dox2, 3)

# Some advanced calculation between dates
max(diet$dox)
range(diet$dox)
mean(diet$dox)
median(diet$dox)
diff(range(diet$dox))
difftime(min(diet$dox), max(diet$dox), units = "weeks")  # Set unit

# Epi::cal.yr() function converts the date format to numeric format
diet2 <- Epi::cal.yr(diet)
str(diet2)
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**3.4**</span> Set time zone & calculation

```{r echo=TRUE}
bd <- '1994-09-22 20:30:00'
class(bd)
bdtime <- strptime(x = bd, format = '%Y-%m-%d %H:%M:%S', tz = "Asia/Shanghai")  # Set character to time format and add a time zone
class(bdtime)
t(unclass(bdtime))
bdtime$wday
format(bdtime, format = '%d.%m.%Y')
bdtime + 1
# Also, some essential calculation
bd2 <- '1995-09-01 7:30:00'
bdtime2 <- strptime(bd2, format = '%Y-%m-%d %H:%M:%S', tz = 'Asia/Shanghai')
bdtime2 - bdtime
difftime(time1 = bdtime2, time2 = bdtime, units = 'secs')  # Set unit
mean(c(bdtime, bdtime2))
```

# <span style="color:gray; font-family:Microsoft JhengHei;">**4**</span> [LaTeX]{style="color:orange"}

## <span style="color:gray; font-family:Microsoft JhengHei;">**4.1**</span> Fundamental

<center><img src="images/Mathematical Annotation in R.png" width="600" height="579"/></center>

-   Use `$$e^{i\pi}+1=0$$` to form Euler's Law expression $$e^{i\pi}+1=0$$
-   [Hyperlink of a CN website for more detail about LaTeX](https://blog.csdn.net/ViatorSun/article/details/82826664)

## <span style="color:gray; font-family:Microsoft JhengHei;">**4.2**</span> Advanced

-   Here are some additional formulas from ENV221 statistic method:<br>
    1.  [Z-test]{style="color:orange"}:<br> The LaTex expression for Z-test is: $$Z=\frac{\overline{x}-\mu}{\frac{\sigma}{\sqrt{n}}}$$ where $\overline{x}$ is the sample mean, $\mu$ is the population mean, $\sigma$ is the population standard deviation, and $n$ is the sample size.
    2.  [t-test]{style="color:orange"}:<br> The LaTex expression for t-test is: $$t=\frac{\overline{x}-\mu}{\frac{s}{\sqrt{n}}}$$ where $\overline{x}$ is the sample mean, $\mu$ is the population mean, $s$ is the sample standard deviation, and $n$ is the sample size.
    3.  [F-test]{style="color:orange"}:<br> The LaTex expression for F-test is: $$F=\frac{s_1^2}{s_2^2}$$ where $s_1^2$ is the variance of the first sample and $s_2^2$ is the variance of the second sample.
    4.  [Chi-square test]{style="color:orange"}:<br> The LaTex expression for the chi-square test is: $$\chi2=\sum_{i=1}{n}\frac{(O_i-E_i)^2}{E_i}$$ where $O_i$ represents observed values and $E_i$ represents expected values.

# <span style="color:gray; font-family:Microsoft JhengHei;">**5**</span> R graph (advanced)

## <span style="color:gray; font-family:Microsoft JhengHei;">**5.1**</span> R graph (advanced)Different theme of plot

```{r, fig.align='center'}
library(ggplot2)
bw <- ggplot(CO2) + geom_point(aes(conc, uptake)) + theme_bw()
test <- ggplot(CO2) + geom_point(aes(conc, uptake)) + theme_test()
classic <- ggplot(CO2) + geom_point(aes(conc, uptake)) + theme_classic()
library(patchwork)
bw + test + classic + 
  plot_layout(ncol = 3, widths = c(1, 1, 1), heights = c(1, 1, 1)) + 
  plot_annotation(
    title = expression(CO[2] * " uptake by plant type plot with different theme"),
    tag_levels = "A"
  )
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**5.2**</span> R graph (advanced)Math formulas with R

```{r, fig.width = 8, fig.height = 4, fig.align='center'}
head(CO2)
# fundamental expression
plot(CO2$conc, CO2$uptake, pch = 16, las = 1, 
     xlab = 'CO2 concentration', ylab = 'CO2 uptake')
# Advanced expression (Use `?plotmath` to check more details of mathematical annotation in R)
plot(CO2$conc, CO2$uptake, pch = 16, las = 1, 
     xlab = expression('CO'[2] * ' concentration (mL/L)'), 
     ylab = expression('CO'[2] * ' uptake (' *mu * 'mol m'^-2 * 's'^-1 * ')'))
# LaTeX expression
library(latex2exp)
plot(CO2$conc, CO2$uptake, pch = 16, las = 1, 
     xlab = TeX('CO$_2$ concentration (mL/L)'), 
     ylab = TeX('CO$_2$ uptake ($\\mu$mol m$^{-2}$ s$^{-1}$)'))
text(850, 30, expression(prod(plain(P)(X == x), x)))
```

-   [Hyperlink of a CN website for more detail about Mathematical Annotation in R](https://www.cnblogs.com/kisen/p/12574830.html)

## <span style="color:gray; font-family:Microsoft JhengHei;">**5.3**</span> R graph (advanced)Size and layout

-   ggplot2: patchwork package is used to range the size and layout of multiply plots

```{r, fig.width = 8, fig.height = 5, fig.align='center'}
library(patchwork)
p1 <- ggplot(airquality) + geom_boxplot(aes(as.factor(Month), Ozone))
p2 <- ggplot(airquality) + geom_point(aes(Solar.R, Ozone))
p3 <- ggplot(airquality) + geom_histogram(aes(Ozone))
p1 + p2 + p3
p1 + p2 / p3
(p1 + p2) / p3
(p1 + p2) / p3 + plot_annotation(tag_levels = 'A') + 
  plot_layout(ncol = 2, widths = c(1, 1), heights = c(1, 1))  # plot_layout() function is used to define the grid layout of the composite graph.
```

-   Built-in par() function

```{r}
par(mfrow = c(2, 3))  # Set the layout by using vector c(x, y)
plot(airquality$Solar.R, airquality$Ozone)
hist(airquality$Solar.R)
barplot(airquality$Month)
plot(airquality$Solar.R, airquality$Ozone)
hist(airquality$Solar.R)
barplot(airquality$Month)
```

-   <span style="color:red">Built-in layout() function</span>

```{r, fig.width = 8, fig.height = 5, fig.align='center'}
# Use a matrix to store the information about layout
mymat <- matrix(1:6, nrow = 2)
layout(mymat)
plot(airquality$Solar.R, airquality$Ozone)
hist(airquality$Solar.R)
barplot(airquality$Month)
plot(airquality$Solar.R, airquality$Ozone)
hist(airquality$Solar.R)
barplot(airquality$Month)
# Also, customize the exact layout by using some parameters like 'widths=' and 'heights=' by filling vector
mymat <- matrix(c(1, 1:5), nrow = 2)
mymat  # Check the matrix which was used to layout plots
layout(mymat, widths = c(1, 1, 2), heights = c(1, 2))
plot(airquality$Solar.R, airquality$Ozone)
hist(airquality$Solar.R)
barplot(airquality$Month)
plot(airquality$Solar.R, airquality$Ozone)
hist(airquality$Solar.R)
# This is an example from quiz1. Also, please check the exercises to view more difficult questions
mymat <- matrix(c(1, 2, 3, 0), nrow = 2)
mymat  # Check the matrix which was used to layout plots
layout(mymat, widths = c(4, 1), heights = c(2, 1))  # Set the ratio between widths and heights
plot(iris$Sepal.Length, iris$Sepal.Width, pch=20, xlab='Sepal Length (cm)', ylab='Sepal Width (cm)', las=1)
boxplot(iris$Sepal.Length, pch=20, las=1, horizontal=T)
boxplot(iris$Sepal.Width, pch=20, las=2)
```

# <span style="color:gray; font-family:Microsoft JhengHei;">**6**</span> R Tidyverse

## <span style="color:gray; font-family:Microsoft JhengHei;">**6.1**</span> Workflow

<center>![Tidyverse workflow](images/Tidyverse workflow.png){width=75%}</center>

## <span style="color:gray; font-family:Microsoft JhengHei;">**6.2**</span> Fundamental operations
```{r}
# Load the package
library(tidyverse)
# Check the members of them
tidyverse_packages()
```
Core members and their function:

- `ggplot2`: Creating graphics
- `dplyr`: Data manipulation
- `tidyr`: Get to tidy data
- `readr`: Read rectangular data
- `purrr`: Functional programming
- `tibble`: Re-imagining of the data frame
- `stringr`: Working with strings
- `forcats`: Working with factors

## <span style="color:gray; font-family:Microsoft JhengHei;">**6.3**</span> Pipe operator

The pipe operator can be written as `%>%` or `|>`
```{r}
x <- c(0.109, 0.359, 0.63, 0.996, 0.515, 0.142, 0.017, 0.829, 0.907)
# Method 1:
y1 <- log(x)
y2 <- diff(y1)
y3 <- exp(y2)
z <- round(y3)
# Method 2
z <- round(exp(diff(log(x))))
# Pipe method
z <- x %>% log() %>% diff() %>% exp() %>% round()
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**6.4**</span> Mutiply work by using tidyverse pipe

### <span style="color:gray; font-family:Microsoft JhengHei;">**6.4.1**</span> Graph work
```{r, fig.align='center'}
# By using R built-in par() function and a loop
par(mfrow = c(2, 2))
for (i in 1:4) {
  boxplot(iris[, i] ~ iris$Species, las = 1, xlab = 'Species', ylab = names(iris)[i])
}
# By using pivot_longer() function and tidyverse pipe
iris |> pivot_longer(-Species) |> ggplot() + geom_boxplot(aes(Species, value)) + facet_wrap(name ~.)
```
### <span style="color:gray; font-family:Microsoft JhengHei;">**6.4.2**</span> Statistic work
```{r}
# base R
dtf1_mean <- data.frame(Species = unique(iris$Species), Mean_Sepal_Length = tapply(iris$Sepal.Length, iris$Species, mean, na.rm = TRUE))
dtf1_sd <- data.frame(Species = unique(iris$Species), SD_Sepal_Length = tapply(iris$Sepal.Length, iris$Species, sd, na.rm = TRUE))
dtf1_median <- data.frame(Species = unique(iris$Species), Median_Sepal_Length = tapply(iris$Sepal.Length, iris$Species, median, na.rm = TRUE))
names(dtf1_mean) <- c("Species", "Mean_Sepal_Length")
names(dtf1_sd) <- c("Species", "SD_Sepal_Length")
names(dtf1_median) <- c("Species", "Median_Sepal_Length")
cbind(dtf1_mean, dtf1_sd, dtf1_median)  # Show them in one table
# use a loop
dtf <- data.frame(rep(NA, 3))
for (i in 1:4) {
  dtf1_mean <- data.frame(tapply(iris[, i], iris$Species, mean, na.rm = TRUE))
  dtf1_sd <- data.frame(tapply(iris[, i], iris$Species, sd, na.rm = TRUE))
  dtf1_median <- data.frame(tapply(iris[, i], iris$Species, median, na.rm = TRUE))
  dtf1 <- cbind(dtf1_mean, dtf1_sd, dtf1_median)
  names(dtf1) <- paste0(names(iris)[i], '.', c('mean', 'sd', 'median'))
  dtf <- cbind(dtf, dtf1)
}
dtf
# tidyverse
dtf <- iris |> 
  pivot_longer(-Species) |> 
  group_by(Species, name) |> 
  summarise(mean = mean(value, na.rm = TRUE),
            sd   = sd(value, na.rm = TRUE),
            median = median(value, na.rm = TRUE),
            .groups = "drop")

dtf
```



## <span style="color:gray; font-family:Microsoft JhengHei;">**6.5**</span> Tidy the dataset

```{r}
# Original dataset of table1
table1
# Compute rate per 10,000
table1 %>% mutate(rate = cases / population * 10000)
# Compute cases per year
table1 %>% count(year, wt = cases)
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**6.6**</span> Conversions the dataframe type

```{r}
# Original dataset of table2
table2
# Divided the type into cases and population
table2 %>% pivot_wider(names_from = type, values_from = count)
# Original dataset of table3
table3
# Separate the rate into cases and population
table3 %>% separate(col = rate, into = c("cases", "population"), sep = "/")
# Original dataset of table4a and table4b
cbind(table4a, table4b)
# Put table4a and table4b together to form a new table with both of their dataset
tidy4a_changed <- table4a %>% pivot_longer(c(`1999`, `2000`), names_to = "year", values_to = "cases")
tidy4b_changed <- table4b %>% pivot_longer(c(`1999`, `2000`), names_to = "year", values_to = "population")
left_join(tidy4a_changed, tidy4b_changed)   ## Kind of like MySQL
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**6.7**</span> Find missing observations

```{r}
library(openair)
library(tidyverse)
# create a function to count missing observations
sum_of_na <- function(x){
  sum(is.na(x))
}
mydata %>% summarise(
  across(everything(), sum_of_na)
)
```

# <span style="color:gray; font-family:Microsoft JhengHei;">**7**</span> ANOVA (Post-hoc tests)

## <span style="color:gray; font-family:Microsoft JhengHei;">**7.1**</span> Post-hoc tests

Background informations: A biologist studies the weight gain of male lab rats on diets over a 4-week period. Three different diets are applied.

```{r, fig.width = 6, fig.height = 4, fig.align='center'}
# Statistic anlysis
(dtf <- data.frame(diet1 = c(90, 95, 100),
                   diet2 = c(120, 125, 130),
                   diet3 = c(125, 130, 135)))
dtf2 <- stack(dtf)
names(dtf2) <- c("wg", "diet")
wg_aov <- aov(wg ~ diet, data = dtf2)
summary(wg_aov)
# Visualization
library(ggplot2)
ggplot(dtf2) + geom_boxplot(aes(wg, diet))
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**7.2**</span> Fisher‚Äôs Least Significant Difference (LSD) Test

### <span style="color:gray; font-family:Microsoft JhengHei;">**7.2.1**</span> Concept

Pair-wise comparisons of all the groups based on the $t$-test:
$$L S D=t_{\alpha / 2} \sqrt{S_{p}^{2}\left(\frac{1}{n_1}+\frac{1}{n_2}+\cdots\right)}$$
$$S_{p}^{2}=\frac{\left(n_{1}-1\right) S_{1}^{2}+\left(n_{2}-1\right) S_{2}^{2}+\left(n_{3}-1\right) S_{3}^{2}+\cdots}{\left(n_{1}-1\right)+\left(n_{2}-1\right)+\left(n_{3}-1\right)+\cdots}$$

- $S_{p}^{2}:$: pooled standard deviation (some use Mean Standard Error)
- $t_{\alpha / 2}: \mathrm{t}$: $t$ critical value at $\alpha=0.025$
- Degree of freedom: $N - k$
    - $N$: total observations
    - $k$: number of factors
- If $\left|\bar{x}_{1}-\bar{x}_{2}\right|>L S D$, then the difference of $x_1$ group and $x_2$ group is significant at $\alpha$.
- In multiple comparisons ($k$ factors), the number of comparison needed is: $\frac{k(k-1)}{2}$

### <span style="color:gray; font-family:Microsoft JhengHei;">**7.2.2**</span> Example
(Rats on diets in the previous section)

1. Step by step
```{r}
# Calculate LSD
n <- nrow(dtf2)
k <- nlevels(dtf2$diet)
dfree <- n - k
t_critical <- qt(0.05/2, df = dfree, lower.tail = FALSE)
sp2 <- sum((3 - 1) * apply(dtf, 2, sd) ^ 2)/ dfree
LSD <- t_critical * sqrt(sp2 * (1/3 + 1/3 + 1/3))
# Calculate |mean_x1-mean_x2|
dtf_groupmean <- colMeans(dtf)
paired_groupmean <- combn(dtf_groupmean, 2)
paired_groupmean[2, ] - paired_groupmean[1, ]
```
2. Step by step by using loop
```{r}
library(dplyr)
dtf_sm <- dtf2 |> 
  group_by(diet) |> 
  summarise(n = length(wg), sd = sd(wg), mean = mean(wg))
sp2 <- sum((dtf_sm$n - 1) * dtf_sm$sd ^ 2 )/ dfree
LSD <- t_critical * sqrt(sp2 * sum(1 / dtf_sm$n))
paired_groupmean <- combn(dtf_sm$mean, 2)
paired_groupmean[2, ] - paired_groupmean[1, ]
```
3. One step
```{r, fig.width = 6, fig.height = 4, fig.align='center'}
library(agricolae)
# Statistic analysis
LSD.test(wg_aov, "diet", p.adj = "bonferroni") |> print()
# Visualization
LSD.test(wg_aov, "diet", p.adj = "bonferroni") |> plot()
box()
```
Conclusion: At $\alpha = 0.05$, Diet 2 and Diet 3 are significantly different from Diet 1 in the mean weight gain, while Diet 2 is not significantly different from Diet 3.

## <span style="color:gray; font-family:Microsoft JhengHei;">**7.3**</span> Bonferroni t-test

### <span style="color:gray; font-family:Microsoft JhengHei;">**7.3.1**</span> Concept

A multiple-comparison post-hoc test, which sets the significance cut off at $\alpha/m$ for each comparison, where $m$ represents [the <u>number</u> of comparisons we apply]{style="color:red"}.

[Overall chance of making a Type I error:]{style="color:#880000"}
```{r}
m <- 1:100
siglevel <- 0.05
Type_I <- 1 - (1 - (siglevel / m)) ^ m
Type_I
```

### <span style="color:gray; font-family:Microsoft JhengHei;">**7.3.2**</span> Example
(Rats on diets in the previous section)

1. Step by step
```{r}
m <- choose(nlevels(dtf2$diet), 2)  # 1:2 or 1:3 or 2:3
alpha_cor <- 0.05 / m
```
```{r}
# Pairwise comparison between diet1 and diet2
t.test(wg ~ diet, dtf2, subset = diet %in% c("diet1", "diet2"), conf.level = 1 - alpha_cor)
# Pairwise comparison between diet1 and diet3
t.test(wg ~ diet, dtf2, subset = diet %in% c("diet1", "diet3"), conf.level = 1 - alpha_cor)
# Pairwise comparison between diet2 and diet3
t.test(wg ~ diet, dtf2, subset = diet %in% c("diet2", "diet3"), conf.level = 1 - alpha_cor)
```
2. One step
```{r}
(diet_pt <- pairwise.t.test(dtf2$wg, dtf2$diet, pool.sd = FALSE,var.equal = TRUE, p.adj = "none"))
diet_pt$p.value < 0.05
```
Conclusion: At $\alpha = 0.05$, Diet 2 and Diet 3 are significantly different from Diet 1 in the mean weight gain, while Diet 2 is not significantly different from Diet 3.

# <span style="color:gray; font-family:Microsoft JhengHei;">**8**</span> MANOVA
<center>![One-Way ANOVA (ENV221)](images/One-Way ANOVA.jpg)</center>
<center>![Two-Way ANOVA (ENV221)](images/Two-Way ANOVA.jpg)</center>
<center>[The Differences Between ANOVA, ANCOVA, MANOVA, and MANCOVA](https://www.statology.org/differences-between-anova-ancova-manova-mancova/)</center>

## <span style="color:gray; font-family:Microsoft JhengHei;">**8.1**</span> Definition of MANOVA

**Univariate Analysis of Variance (ANOVA):**
- one dependent variable (continuous) ~ one or multiple independent variables (categorical).  
**Multivariate Analysis of Variance (MANOVA)**
- multiple dependent variables (continuous) ~ one or multiple independent variables (categorical).  
Comparing multivariate sample means. It uses the covariance between outcome variables in testing the statistical significance of the mean differences when there are multiple dependent variables.  
Merit of MANOVA:
1. Reduce the Type I error
2. It allows for the analysis of multiple dependent variables simultaneously
3. It provides information about the strength and direction of relationships

## <span style="color:gray; font-family:Microsoft JhengHei;">**8.2**</span> Coding and visualization

**Example:** Influence of <u>teaching methods</u> on student <u>satisfaction scores</u> and <u>exam scores</u>.
```{r, fig.width = 6, fig.height = 4, fig.align='center'}
dtf <- read.csv('data/teaching_methods.csv')
head(dtf, 3)
# ANOVA between Test and Method
summary(aov(Test ~ Method, data = dtf))
# ANOVA between Satisfaction and Method
summary(aov(Satisfaction ~ Method, data = dtf))
# Visualization with Scatter plot
library(ggplot2)
library(tidyr)
dtf |> pivot_longer(-Method) |> 
  ggplot() + 
  geom_dotplot(aes(x = Method, y = value, group = Method), binaxis = "y", stackdir = "center") + 
  facet_wrap(name~.)
# Visualization with Box plot
par(mfrow = c(1, 3))
boxplot(Test ~ Method, data = dtf)
boxplot(Satisfaction ~ Method, data = dtf)
plot(dtf$Satisfaction, dtf$Test, col = dtf$Method, pch = 16, xlab = 'Satisfaction', ylab = 'Test')
# MANOVA method: use manova() function with multiple response variables ~ one or multiple factor
# column bind way
tm_manova <- manova(cbind(dtf$Test, dtf$Satisfaction) ~ dtf$Method)
# matrix way
tm_manova <- manova(as.matrix(dtf[, c('Test', 'Satisfaction')]) ~ dtf$Method)
summary(tm_manova)
```

## <span style="color:gray; font-family:Microsoft JhengHei;">**8.3**</span> One-way MANOVA

<center>![One-way MANOVA](images/One-way MANOVA.jpg)</center>
**Example:** The iris dataset. Do the species have influence on the sepal size?
```{r, fig.align='center'}
# Visualization
library(ggplot2)
library(tidyr)
iris[, c('Species', 'Sepal.Length', 'Sepal.Width')] |> 
  pivot_longer(cols = c(Sepal.Length, Sepal.Width)) |> 
  ggplot() +
  geom_boxplot(aes(Species, value, fill = name)) +
  labs(y = 'Size (cm)', fill = '')
library(gplots)
par(mfrow = c(1, 2))
plotmeans(iris$Sepal.Length ~ iris$Species)
plotmeans(iris$Sepal.Width ~ iris$Species)
```
**Hypothesis:** multivariate normality test
- $H_0$: The population means of the sepal length and the sepal width are not different across the species.
```{r}
# Summary MANOVA result with different test method
SepalSize <- cbind(iris$Sepal.Length, iris$Sepal.Width)
iris_manova <- manova(SepalSize ~ iris$Species)
summary(iris_manova, test = 'Pillai')  # default
summary(iris_manova, test = 'Wilks')
summary(iris_manova, test = 'Roy')
summary(iris_manova, test = 'Hotelling-Lawley')
# Univariate ANOVAs for each dependent variable
summary.aov(iris_manova)
```
**Conclusion:** The species has a statistically significant effect on the sepal width and sepal length.

## <span style="color:gray; font-family:Microsoft JhengHei;">**8.4**</span> Post-hoc test

**Example:** after One-way MANOVA gives a significant result, which group(s) is/are different from other(s)?  
**Hypothesis:** Linear Discriminant Analysis (LDA)
```{r, fig.align='center'}
# Visualization
library(MASS)
iris_lda <- lda(iris$Species ~ SepalSize, CV = FALSE)
plot_lda <- data.frame(Species = iris$Species, lda = predict(iris_lda)$x)
ggplot(plot_lda) + geom_point(aes(x = lda.LD1, y = lda.LD2, colour = Species))
```
**Conclusion:** The sepal size of the setosa species is different from other species.

## <span style="color:gray; font-family:Microsoft JhengHei;">**8.5**</span> Multivariate normality

### <span style="color:gray; font-family:Microsoft JhengHei;">**8.5.1**</span> Shapiro-Wilk test

**Hypothesis:**  
$H_0$: The variable follows a normal distribution
```{r}
library(rstatix)
iris |>  
  group_by(Species) |>  
  shapiro_test(Sepal.Length, Sepal.Width)
```
Tip:

- <span style="color:green">If the sample size is large (say n > 50), the visual approaches such as QQ-plot and histogram will be better for assessing the normality assumption.</span>
```{r, fig.align='center'}
iris[, c('Species', 'Sepal.Length', 'Sepal.Width')] |> 
  pivot_longer(cols = c(Sepal.Length, Sepal.Width)) |> 
  ggplot() +
  geom_histogram(aes(value)) +
  facet_grid(name ~ Species)
```
**Conclusion:** As $p>0.05$, the sepal length and the width for each species are normally distributed.

### <span style="color:gray; font-family:Microsoft JhengHei;">**8.5.2**</span> Mardia‚Äôs skewness and kurtosis test

**Hypothesis:**  
$H_0$: The variables follow a multivariate normal distribution
```{r}
library(mvnormalTest)
mardia(iris[, c('Sepal.Length', 'Sepal.Width')])$mv.test
```
Tip:

- <span style="color:green">When n > 20 for each combination of the independent and dependent variable, the multivariate normality can be assumed (Multivariate Central Limit Theorem).</span>  

**Conclusion:** As $p>0.05$, the sepal length and the width follow a multivariate normal distribution.

### <span style="color:gray; font-family:Microsoft JhengHei;">**8.5.3**</span> Homogeneity of the variance-covariance matrix
**Main:**  
Box‚Äôs M test: Use a lower $\alpha$ level such as $\alpha = 0.001$ to assess the $p$ value for significance.  
**Hypothesis:**  
$H_0$: The variance-covariance matrices are equal for each combination formed by each group in the independent variable.
```{r}
library(biotools)
boxM(cbind(iris$Sepal.Length, iris$Sepal.Width), iris$Species)
```
**Conclusion:** As $p < 0.001$, the variance-covariance matrices for the sepal length and width are not equal for each combination formed by each species.

### <span style="color:gray; font-family:Microsoft JhengHei;">**8.5.4**</span> Multivariate outliers
- [MANOVA is highly sensitive to outliers and may produce Type I or II errors.]{style="color:red"}
- Multivariate outliers can be detected using the Mahalanobis Distance test. The larger the Mahalanobis Distance, the more likely it is an outlier.
```{r}
library(rstatix)
iris_outlier <- mahalanobis_distance(iris[, c('Sepal.Length', 'Sepal.Width')])
head(iris_outlier, 5)
```

### <span style="color:gray; font-family:Microsoft JhengHei;">**8.5.5**</span> Linearity
- Or test the regression or the slope (ENV221)
```{r}
# Visualize the pairwise scatterplot for the dependent variable for each group
ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  facet_wrap(Species ~ .)
```

### <span style="color:gray; font-family:Microsoft JhengHei;">**8.5.6**</span> Multicollinearity
Correlation between the dependent variable.  
For three or more dependent variables, use a correlation matrix or variance inflation factor (VIF).
```{r}
# Test the correlation
cor.test(x = iris$Sepal.Length, y = iris$Sepal.Width)
# Visualization
ggplot(iris, aes(Sepal.Length, Sepal.Width)) +
  geom_point() +
  geom_smooth(method = 'lm')
```
- If $|r|$ > 0.9, there is multicollinearity.
- If r is too low, perform separate univariate ANOVA for each dependent variable.

## <span style="color:gray; font-family:Microsoft JhengHei;">**8.6**</span> Two-way MANOVA

<center>![Two-way MANOVA](images/Two-way MANOVA.jpg)</center>
**Example:** Plastic. Do the rate of extrusion and the additive have influence on the plastic quality?
```{r}
# Summary MANOVA result
data('Plastic', package = 'heplots')
Plastic_matrix <- as.matrix(Plastic[, c('tear','gloss','opacity')])
Plastic_manova <- manova(Plastic_matrix ~ Plastic$rate * Plastic$additive)
summary(Plastic_manova)
# Univariate ANOVAs for each dependent variable
summary.aov(Plastic_manova)
```

# <span style="color:gray; font-family:Microsoft JhengHei;">**9**</span> ANCOVA

## <span style="color:gray; font-family:Microsoft JhengHei;">**9.1**</span> Definition of ANCOVA
<span style="color:red">Test whether the independent variable(s) has a significant influence on the dependent variable, excluding the influence of the covariate (preferably highly correlated with the dependent variable)</span>
$$Y_{ij} = (\mu+\tau_{i})+\beta(x_{ij}-\bar{x})+\epsilon_{ij}$$

- $Y_{ij}$: the j-th observation under the i-th categorical group
- $\mu$: the population mean
- $i$: groups, 1,2, ‚Ä¶
- $j$: observations, 1,2,‚Ä¶
- $\tau_i$: an adjustment to the y intercept for the i-th regression line
- $\mu + \tau_i$: the intercept for group i
- $\beta$: the slope of the line
- $x_{ij}$: the j-th observation of the continuous variable under the i-th group
- $\bar x$: the global mean of the variable x
- $\epsilon _{ij}$: the associated unobserved error

**Analysis of covariance (ANCOVA):**

- Dependent variable (DV): One continuous variable
- Independent variables (IVs): One or multiple categorical variables, one or multiple continuous variables (covariate, CV)

**Covariate (CV):**

- An independent variable that is not manipulated by experimenters but still influences experimental results.

**Example:**

<center>![Model simplification](images/ANCOVA-plot.png)</center>

## <span style="color:gray; font-family:Microsoft JhengHei;">**9.2**</span> One-way ANCOVA

### <span style="color:gray; font-family:Microsoft JhengHei;">**9.2.1**</span> Question

<center>![One-Way ANCOVA](images/One-Way ANOVA.jpg)</center>

**Example 1:** Does <u>grazing</u> have influence on the fruit production? Are grazed plants have more fruit <u>production</u> than ungrazed ones?

- Independent variable: 
   - Grazing (categorical)
- Dependent variable: 
   - Fruit production (continuous)
```{r, fig.width = 6, fig.height = 4, fig.align='center'}
df1 <- read.table("data/ipomopsis.txt", header = TRUE, stringsAsFactors = TRUE)
head(df1, 5)
tapply(df1$Fruit,df1$Grazing, mean)
library(ggplot2)
ggplot(df1) + geom_boxplot(aes(Fruit, Grazing))
# Hypothesis test
t.test(Fruit ~ Grazing, data = df1, alternative = c("greater"))
```
**Example 2:** What is the influence of <u>grazing</u> and <u>root diameter</u> on the fruit production of a plant?

Independent variables:

- grazing (categorical: grazed or ungrazed)
- root diameter (continuous, mm, covariate)

Dependent variable:

- fruit production (mg)

```{r}
# Visualization
ggplot(df1, aes(Root, Fruit))+
  geom_point() +
  geom_smooth(method = 'lm') +
  geom_point(aes(color = Grazing)) + 
  geom_smooth(aes(color = Grazing), method = 'lm')
```

### <span style="color:gray; font-family:Microsoft JhengHei;">**9.2.2**</span> Maximal model

| Symbol | Meaning |
|:---:|:-----|
| `~` | Separating DV (<span style="color:red">left</span>) and IV (<span style="color:red">right</span>) |
| `:` | Interaction effect of two factors |
| `*` | Main effect of the two factors and the interaction effect. `f1 * f2` is equivalent to `f1 + f2 + f1:f2` |
| `^` | Square the sum of several terms. The main effect of these terms and the interaction between them |
| `.` | All variables except the DV |
```{r}
# The maximal model
df1_ancova <- lm(Fruit ~ Grazing * Root, data = df1)
summary(df1_ancova)
# The ANOVA table for the maximal model
anova(df1_ancova)
# other method to see the ANOVA table 
df1_aov <- aov(Fruit ~ Grazing * Root, data = df1)
summary(df1_aov)
summary.aov(df1_ancova)
```

### <span style="color:gray; font-family:Microsoft JhengHei;">**9.2.3**</span> Minimal model

```{r}
# Delete the interaction factor 
df1_ancova2 <- update(df1_ancova, ~ . - Grazing:Root)
summary(df1_ancova2)
# Compare the simplified model with the maximal model
anova(df1_ancova, df1_ancova2)
# Delete the grazing factor 
df1_ancova3 <- update(df1_ancova2, ~ . - Grazing)
summary(df1_ancova3)
# Compare the two models
anova(df1_ancova2, df1_ancova3)
summary(df1_ancova2)
anova(df1_ancova2)
```

### <span style="color:gray; font-family:Microsoft JhengHei;">**9.2.4**</span> One step

Criterion: Akaike‚Äôs information criterion (AIC). The model is <u>worse</u> if AIC gets <u>greater</u>.
```{r}
step(df1_ancova)
```


### <span style="color:gray; font-family:Microsoft JhengHei;">**9.2.5**</span> Result

```{r}
# Extracting formulas from linear regression models
equatiomatic::extract_eq(df1_ancova2, use_coefs = TRUE)
```
<a id="diagnostic statistical data text table"></a>
```{r}
# Create a diagnostic statistical data text table
stargazer::stargazer(df1_ancova2, type = 'text')
```
<details>
  <summary>The meaning of each parameter in this table</summary>
- Dependent variable: The name of the dependent variable.
- Independent variables: The names of the independent variables.
- Coefficients: Regression coefficients, indicating the degree to which an independent variable affects the dependent variable when it increases by one unit.
- Standard errors: Standard error of regression coefficients, measuring the stability of regression coefficients.
- t-statistics: t-value of regression coefficients, representing whether a regression coefficient is significantly different from zero and has a significant impact on the dependent variable.
- p-values: Significance level of regression coefficients, usually used to determine whether a regression coefficient is significantly different from zero. The smaller the p-value, the more significant the regression coefficient is considered to be.
- Observations: Sample size.
- R2: Goodness-of-fit measure that represents how much variance in explanatory variables can be explained by model. A higher value indicates better fit between model and data
- Adjusted R2ÔºöA modified version of R2 that takes into account number of independent variables for greater accuracy
- Residual standard errorÔºöStandard deviation or dispersion measure for residuals; smaller values indicate better model fit
- F-statisticÔºöStatistical test used to evaluate overall goodness-of-fit for linear models 
- dfÔºöDegrees of freedom 
- Note:p<0.1,p<0.05,p<0.01 : When p-value is less than 0.1, 0.05 or 0.01 respectively,* , ** , *** are used as symbols indicating significance levels for corresponding regressionscoefficients
</details>

## <span style="color:gray; font-family:Microsoft JhengHei;">**9.3**</span> Two-way ANCOVA

<center>![Two-Way ANOVA](images/Two-Way ANOVA.jpg)</center>

### <span style="color:gray; font-family:Microsoft JhengHei;">**9.3.1**</span> Question

Previous experiments have shown that both genotype and sex of an organism affect body weight gain. However, a scientist believes that after adjusting for <u>age</u>, there was no significant difference in means of <u>weight</u> gain between groups at different levels of <u>sex</u> and <u>Genotype</u>. Can experiments support this claim?

- Independent variables: 
   - genotype (categorical)
   - sex (categorical)
   - age (covariate)
- Dependent variable: 
   - Weight gain (continuous)

### <span style="color:gray; font-family:Microsoft JhengHei;">**9.3.2**</span> Model

```{r}
Gain <- read.table("data/Gain.txt", header = T)
head(Gain, 3)
m1 <- lm(Weight ~ Sex * Age * Genotype, data = Gain)
summary(m1)
```
- There are no things like Age:Sex or Age:Genotype, so the slope of weight gain against age does not vary with sex or genotype
- In the final minimal adequate model, three main effects were included (Sex, Age, Genotype), so it can be considered that there are intercept differences between gender, age and genotype (intercepts vary).
- The final minimal adequate model includes three main effects (Sex, Age, Genotype), but no interaction effect. This means that the effects of these variables are independent and there is no interaction between them.

### <span style="color:gray; font-family:Microsoft JhengHei;">**9.3.3**</span> One step

```{r}
m2 <- step(m1)
summary(m2)
```
From the above output, we can see the coefficients of each genotype and their corresponding significance level (in the Estimate column). It can be observed that GenotypeCloneC and GenotypeCloneE have similar effects on the dependent variable, with coefficients close to -1 and very small significance levels (p-value < 0.001). Therefore, we can combine these two factors into one factor, reducing the number of genotype levels from six to five. The same approach can be applied to B and D.
```{r}
# Check
newGenotype <- as.factor(Gain$Genotype)
levels(newGenotype)
# Change
levels(newGenotype)[c(3,5)] <- "ClonesCandE"
levels(newGenotype)[c(2,4)] <- "ClonesBandD"
levels(newGenotype)
# Liner regression & compare
m3 <- lm(Weight ~ Sex + Age + newGenotype, data = Gain)
anova(m2,m3)
```
<details>
  <summary>Analysis of RSS above</summary>
In regression models, the residual sum of squares (RSS) represents the unexplained variance in the dependent variable. In this example, the RSS for Model 1 and Model 2 are 2.7489 and 2.9938 respectively. The goal of a model is to minimize RSS because it represents how well the model fits with observed values. Generally, a smaller RSS indicates a better fit for the model. When comparing two models' fit, one can use both RSS and F-statistic. In this example, although Model 2 has a slightly larger RSS than Model 1, its P-value for F-statistic is 0.1087 which does not reach commonly used significance levels such as 0.05; therefore we cannot reject null hypothesis that Model 2 performs worse than Model 1.
</details>

### <span style="color:gray; font-family:Microsoft JhengHei;">**9.3.4**</span> Result

As $p=0.1087$, there is no significant difference between the two models. Therefore, the new model uses NewGenotype (four levels) instead of Genotype (six levels).
```{r}
summary(m3)
# Extracting formulas from linear regression models
equatiomatic::extract_eq(m3, use_coefs = TRUE)
# Create a diagnostic statistical data text table
stargazer::stargazer(m3, type = 'text')
```
[The meaning of each parameter in this table](#diagnostic statistical data text table)

### <span style="color:gray; font-family:Microsoft JhengHei;">**9.3.5**</span> Visualization

```{r}
plot(Weight~Age,data=Gain,type="n")
colours <- c("green","red","black","blue")
lines <- c(1,2)
symbols <- c(16,17)
NewSex<-as.factor(Gain$Sex)
points(Weight~Age,data=Gain,pch=symbols[as.numeric(NewSex)],
       col=colours[as.numeric(newGenotype)])
xv <- c(1,5)
for (i in 1:2) {
  for (j in 1:4){
    a <- coef(m3)[1]+(i>1)* coef(m3)[2]+(j>1)*coef(m3)[j+2]
 
    b <- coef(m3)[3]
    yv <- a+b*xv
    lines(xv,yv,lty=lines[i],col=colours[j]) } }
```

# <span style="color:gray; font-family:Microsoft JhengHei;">**10**</span> MANCOVA




















# [SessionInfo:]{style="color:green"}

```{r, echo=FALSE}
sessionInfo()
```